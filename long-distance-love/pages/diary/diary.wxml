<!--pages/diary/diary.wxml-->
<view class="container">
  <!-- å¤´éƒ¨æ ‡é¢˜ -->
  <view class="header">
    <text class="header-title">æˆ‘ä»¬çš„æ—¥è®°</text>
    <text class="header-subtitle">è®°å½•æ¯ä¸€ä¸ªç¾å¥½æ—¶åˆ»</text>
  </view>

  <!-- æ—¥è®°åˆ—è¡¨ -->
  <scroll-view class="diary-list" scroll-y="true" refresher-enabled="true" bindrefresherrefresh="onRefresh">
    <view class="diary-item card" wx:for="{{diaries}}" wx:key="id" bindtap="viewDiary" data-id="{{item.id}}">
      <view class="diary-header">
        <view class="diary-date">
          <text class="date-day">{{item.day}}</text>
          <text class="date-month">{{item.month}}</text>
        </view>
        <view class="diary-info">
          <text class="diary-title">{{item.title}}</text>
          <text class="diary-preview">{{item.preview}}</text>
          <view class="diary-meta">
            <text class="diary-author">{{item.author}}</text>
            <text class="diary-time">{{item.timeText}}</text>
          </view>
        </view>
        <view class="diary-mood">
          <text class="mood-icon">{{item.mood}}</text>
        </view>
      </view>
      
      <!-- æ—¥è®°å›¾ç‰‡é¢„è§ˆ -->
      <view class="diary-images" wx:if="{{item.images && item.images.length > 0}}">
        <image class="diary-image" 
               src="{{img}}" 
               mode="aspectFill" 
               wx:for="{{item.images}}" 
               wx:for-item="img" 
               wx:key="*this"
               bindtap="previewImage" 
               data-src="{{img}}"
               data-urls="{{item.images}}"></image>
      </view>
      
      <!-- äº’åŠ¨åŒºåŸŸ -->
      <view class="diary-actions">
        <view class="action-item" bindtap="likeDiary" data-id="{{item.id}}">
          <text class="action-icon {{item.isLiked ? 'liked' : ''}}">{{item.isLiked ? 'â¤ï¸' : 'ğŸ¤'}}</text>
          <text class="action-text">{{item.likes}}</text>
        </view>
        <view class="action-item" bindtap="commentDiary" data-id="{{item.id}}">
          <text class="action-icon">ğŸ’¬</text>
          <text class="action-text">{{item.comments}}</text>
        </view>
        <view class="action-item" bindtap="shareDiary" data-id="{{item.id}}">
          <text class="action-icon">ğŸ“¤</text>
          <text class="action-text">åˆ†äº«</text>
        </view>
      </view>
    </view>
    
    <!-- ç©ºçŠ¶æ€ -->
    <view class="empty-state" wx:if="{{diaries.length === 0}}">
      <text class="empty-icon">ğŸ“</text>
      <text class="empty-text">è¿˜æ²¡æœ‰æ—¥è®°å“¦</text>
      <text class="empty-tip">ç‚¹å‡»å³ä¸‹è§’æŒ‰é’®å¼€å§‹å†™æ—¥è®°å§</text>
    </view>
  </scroll-view>

  <!-- å†™æ—¥è®°æŒ‰é’® -->
  <view class="fab" bindtap="writeDiary">
    <text class="fab-icon">âœï¸</text>
  </view>
</view>

<!-- å†™æ—¥è®°æ¨¡æ€æ¡† -->
<view class="diary-modal" wx:if="{{showModal}}">
  <view class="modal-content">
    <view class="modal-header">
      <text class="modal-title">{{isEditing ? 'ç¼–è¾‘æ—¥è®°' : 'å†™æ—¥è®°'}}</text>
      <view class="modal-close" bindtap="closeModal">
        <text class="close-icon">âœ•</text>
      </view>
    </view>
    
    <scroll-view class="modal-body" scroll-y="true">
      <!-- æ—¥è®°æ ‡é¢˜ -->
      <view class="input-group">
        <text class="input-label">æ ‡é¢˜</text>
        <input class="input-field" 
               placeholder="ç»™è¿™ç¯‡æ—¥è®°èµ·ä¸ªæ ‡é¢˜å§" 
               value="{{currentDiary.title}}" 
               bindinput="onTitleInput"/>
      </view>
      
      <!-- å¿ƒæƒ…é€‰æ‹© -->
      <view class="input-group">
        <text class="input-label">ä»Šå¤©çš„å¿ƒæƒ…</text>
        <view class="mood-selector">
          <view class="mood-item {{currentDiary.mood === item ? 'selected' : ''}}" 
                wx:for="{{moods}}" 
                wx:key="*this" 
                bindtap="selectMood" 
                data-mood="{{item}}">
            <text class="mood-emoji">{{item}}</text>
          </view>
        </view>
      </view>
      
      <!-- æ—¥è®°å†…å®¹ -->
      <view class="input-group">
        <text class="input-label">å†…å®¹</text>
        <textarea class="textarea-field" 
                  placeholder="è®°å½•ä»Šå¤©å‘ç”Ÿçš„ç¾å¥½äº‹æƒ…..." 
                  value="{{currentDiary.content}}" 
                  bindinput="onContentInput"
                  maxlength="1000"
                  show-confirm-bar="false"></textarea>
        <text class="char-count">{{currentDiary.content.length}}/1000</text>
      </view>
      
      <!-- å›¾ç‰‡ä¸Šä¼  -->
      <view class="input-group">
        <text class="input-label">æ·»åŠ å›¾ç‰‡</text>
        <view class="image-upload">
          <view class="uploaded-images" wx:if="{{currentDiary.images.length > 0}}">
            <view class="uploaded-item" wx:for="{{currentDiary.images}}" wx:key="*this">
              <image class="uploaded-image" src="{{item}}" mode="aspectFill"></image>
              <view class="delete-image" bindtap="deleteImage" data-index="{{index}}">
                <text class="delete-icon">âœ•</text>
              </view>
            </view>
          </view>
          <view class="upload-btn" bindtap="chooseImages" wx:if="{{currentDiary.images.length < 9}}">
            <text class="upload-icon">ğŸ“·</text>
            <text class="upload-text">æ·»åŠ å›¾ç‰‡</text>
          </view>
        </view>
      </view>
    </scroll-view>
    
    <view class="modal-footer">
      <button class="btn-secondary" bindtap="closeModal">å–æ¶ˆ</button>
      <button class="btn-primary" bindtap="saveDiary">{{isEditing ? 'ä¿å­˜' : 'å‘å¸ƒ'}}</button>
    </view>
  </view>
</view>

<!-- æ—¥è®°è¯¦æƒ…æ¨¡æ€æ¡† -->
<view class="detail-modal" wx:if="{{showDetailModal}}">
  <view class="detail-content">
    <view class="detail-header">
      <view class="detail-close" bindtap="closeDetailModal">
        <text class="close-icon">âœ•</text>
      </view>
    </view>
    
    <scroll-view class="detail-body" scroll-y="true">
      <view class="detail-info">
        <text class="detail-title">{{selectedDiary.title}}</text>
        <view class="detail-meta">
          <text class="detail-author">{{selectedDiary.author}}</text>
          <text class="detail-date">{{selectedDiary.fullDate}}</text>
          <text class="detail-mood">{{selectedDiary.mood}}</text>
        </view>
      </view>
      
      <view class="detail-content-text">
        <text class="content-text">{{selectedDiary.content}}</text>
      </view>
      
      <view class="detail-images" wx:if="{{selectedDiary.images && selectedDiary.images.length > 0}}">
        <image class="detail-image" 
               src="{{img}}" 
               mode="aspectFit" 
               wx:for="{{selectedDiary.images}}" 
               wx:for-item="img" 
               wx:key="*this"
               bindtap="previewImage" 
               data-src="{{img}}"
               data-urls="{{selectedDiary.images}}"></image>
      </view>
    </scroll-view>
    
    <view class="detail-footer">
      <view class="detail-actions">
        <view class="action-item" bindtap="likeDiary" data-id="{{selectedDiary.id}}">
          <text class="action-icon {{selectedDiary.isLiked ? 'liked' : ''}}">{{selectedDiary.isLiked ? 'â¤ï¸' : 'ğŸ¤'}}</text>
          <text class="action-text">{{selectedDiary.likes}}</text>
        </view>
        <view class="action-item" bindtap="commentDiary" data-id="{{selectedDiary.id}}">
          <text class="action-icon">ğŸ’¬</text>
          <text class="action-text">è¯„è®º</text>
        </view>
        <view class="action-item" bindtap="editDiary" data-id="{{selectedDiary.id}}">
          <text class="action-icon">âœï¸</text>
          <text class="action-text">ç¼–è¾‘</text>
        </view>
      </view>
    </view>
  </view>
</view>