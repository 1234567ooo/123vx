<!--pages/chat/chat.wxml-->
<view class="container">
  <!-- èŠå¤©å¤´éƒ¨ -->
  <view class="chat-header">
    <view class="partner-info">
      <image class="partner-avatar" src="{{partnerInfo.avatarUrl || ''}}" mode="aspectFill"></image>
      <view class="partner-details">
        <text class="partner-name">{{partnerInfo.nickName || 'æˆ‘çš„çˆ±äºº'}}</text>
        <text class="online-status">{{onlineStatus}}</text>
      </view>
    </view>
    <view class="chat-actions">
      <view class="action-btn" bindtap="makeVideoCall">
        <text class="action-icon">ğŸ“¹</text>
      </view>
      <view class="action-btn" bindtap="makeVoiceCall">
        <text class="action-icon">ğŸ“</text>
      </view>
    </view>
  </view>

  <!-- èŠå¤©æ¶ˆæ¯åˆ—è¡¨ -->
  <scroll-view class="chat-messages" scroll-y="true" scroll-top="{{scrollTop}}" scroll-into-view="{{scrollIntoView}}">
    <view class="message-list">
      <view class="message-item {{item.type === 'sent' ? 'sent' : 'received'}}" 
            wx:for="{{messages}}" 
            wx:key="id" 
            id="msg-{{item.id}}">
        
        <!-- æ—¶é—´åˆ†éš”çº¿ -->
        <view class="time-divider" wx:if="{{item.showTime}}">
          <text class="time-text">{{item.timeText}}</text>
        </view>
        
        <!-- æ¶ˆæ¯å†…å®¹ -->
        <view class="message-content">
          <image class="message-avatar" 
                 src="{{item.type === 'sent' ? userInfo.avatarUrl : partnerInfo.avatarUrl}}" 
                 mode="aspectFill"
                 wx:if="{{item.type === 'received'}}"></image>
          
          <view class="message-bubble {{item.type}}">
            <!-- æ–‡æœ¬æ¶ˆæ¯ -->
            <text class="message-text" wx:if="{{item.messageType === 'text'}}">{{item.content}}</text>
            
            <!-- å›¾ç‰‡æ¶ˆæ¯ -->
            <image class="message-image" 
                   src="{{item.content}}" 
                   mode="aspectFit" 
                   bindtap="previewImage" 
                   data-src="{{item.content}}"
                   wx:if="{{item.messageType === 'image'}}"></image>
            
            <!-- è¯­éŸ³æ¶ˆæ¯ -->
            <view class="voice-message" 
                  bindtap="playVoice" 
                  data-src="{{item.content}}"
                  wx:if="{{item.messageType === 'voice'}}">
              <text class="voice-icon">ğŸ¤</text>
              <text class="voice-duration">{{item.duration}}''</text>
            </view>
            
            <!-- çˆ±å¿ƒæ¶ˆæ¯ -->
            <view class="love-message" wx:if="{{item.messageType === 'love'}}">
              <text class="love-icon heart-animation">ğŸ’•</text>
              <text class="love-text">{{item.content}}</text>
            </view>
          </view>
          
          <image class="message-avatar" 
                 src="{{userInfo.avatarUrl}}" 
                 mode="aspectFill"
                 wx:if="{{item.type === 'sent'}}"></image>
        </view>
        
        <!-- æ¶ˆæ¯çŠ¶æ€ -->
        <view class="message-status" wx:if="{{item.type === 'sent'}}">
          <text class="status-text" wx:if="{{item.status === 'sending'}}">å‘é€ä¸­...</text>
          <text class="status-text" wx:if="{{item.status === 'sent'}}">å·²å‘é€</text>
          <text class="status-text" wx:if="{{item.status === 'read'}}">å·²è¯»</text>
        </view>
      </view>
    </view>
  </scroll-view>

  <!-- è¾“å…¥åŒºåŸŸ -->
  <view class="input-area">
    <view class="input-toolbar">
      <view class="toolbar-btn" bindtap="toggleVoiceInput">
        <text class="toolbar-icon">{{isVoiceMode ? 'âŒ¨ï¸' : 'ğŸ¤'}}</text>
      </view>
      <view class="toolbar-btn" bindtap="chooseImage">
        <text class="toolbar-icon">ğŸ“·</text>
      </view>
      <view class="toolbar-btn" bindtap="sendLove">
        <text class="toolbar-icon">ğŸ’•</text>
      </view>
    </view>
    
    <!-- æ–‡æœ¬è¾“å…¥ -->
    <view class="text-input-area" wx:if="{{!isVoiceMode}}">
      <input class="text-input" 
             placeholder="è¾“å…¥æ¶ˆæ¯..." 
             value="{{inputText}}" 
             bindinput="onInputChange"
             confirm-type="send"
             bindconfirm="sendTextMessage"
             focus="{{inputFocus}}"/>
      <button class="send-btn {{inputText ? 'active' : ''}}" 
              bindtap="sendTextMessage" 
              disabled="{{!inputText}}">
        å‘é€
      </button>
    </view>
    
    <!-- è¯­éŸ³è¾“å…¥ -->
    <view class="voice-input-area" wx:if="{{isVoiceMode}}">
      <button class="voice-btn {{isRecording ? 'recording' : ''}}" 
              bindtouchstart="startRecord" 
              bindtouchend="stopRecord"
              bindtouchcancel="cancelRecord">
        {{isRecording ? 'æ¾å¼€å‘é€' : 'æŒ‰ä½è¯´è¯'}}
      </button>
    </view>
  </view>
</view>

<!-- å½•éŸ³æç¤º -->
<view class="recording-modal" wx:if="{{isRecording}}">
  <view class="recording-content">
    <view class="recording-icon">ğŸ¤</view>
    <text class="recording-text">æ­£åœ¨å½•éŸ³...</text>
    <text class="recording-tip">æ¾å¼€å‘é€ï¼Œä¸Šæ»‘å–æ¶ˆ</text>
  </view>
</view>